\chapter{Analysis strategy} \label{sec:fit}

The angular parameters are extracted through an unbinned fit to four variables, the $\PKp\Pgpm\Pgmp\Pgmm$ invariant mass and the three angular variables, using an extended maximum likelihood estimator.

A \textit{blinding} procedure has been used for this analysis, to avoid any bias due to human decisions during the set up of the analysis strategy.
During the steps of event selection, fit strategy definition and validation, and efficiency measurement, only the MC samples and data from the mass sidebands have been used, while the distributions of the events in the signal region were not considered.
Most of the systematic uncertainty studies have been performed with \textit{blinded} datasets.
Some of these studies have been firstly defined and tested on MC samples and data sidebands, then propagated on data signal after the \textit{unblinding} step.
Some other systematic uncertainties, when specified in the description, have been studied directly on data, after the \textit{unblinding} step.
After the analysis strategy and all the steps described here were defined and approved by a committee of reviewer inside the Collaboration, the data in the signal region were \textit{unblinded} and the fit procedure run on them.
The estimation of the statistical uncertainty has been performed entirely after the data \textit{unblinding}.

In the following sections I will give a detailed description of the probability density function used in the fit, and of the methods used to estimate its parameters.

\section{Probability density function}
\label{sec:TotalPDF}

The probability density function (\pdf) used in the fit has the following expression:
\begin{equation} \label{eq:angALL}
  \begin{split}
    \mathrm{pdf}(m,\TK,\TL,\PHI) & = Y^{C}_{S} \biggl[ S^{C}(m)  \, S^a(\cTK,\cTL,\PHI) \, \epsilon^{C}(\TK,\TL,\PHI) \biggr. \\
      & \biggl. + \frac{f^{M}}{1-f^{M}}~S^{M}(m) \, S^a(-\cTK,-\cTL,\PHI) \, \epsilon^{M}(\TK,\TL,\PHI) \biggr] \\
    & + Y_{B}\,B^m(m) \, B^{\TK}(\cTK) \, B^{\TL}(\cTL) \, B^{\PHI}(\PHI), \\
  \end{split}
\end{equation}
where its three terms correspond to the \pdfs for right-tagged signal, mis-tagged signal, and background events, respectively.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The pure-physics information about the angular distribution, derived from the theoretical description of the decay presented in Section~\ref{sec:Kstmm}, are contained in $S^a(\cTK,\cTL,\PHI)$.
This term is defined as the differential decay distribution, which has been formulated, after the angular folding application, in Equation~\ref{eq:PDF-f2}.

In order to describe the data collected in the collisions, we should adapt the theoretical differential distribution to the experimental conditions.
They include the finite resolution of the measured kinematical variables and the distortion of the angular distributions introduced by the geometric acceptance of the detector and the selection criteria.
All these effect are applied by multiplying the decay distribution by the efficiency function $\epsilon^{C}(\TK,\TL,\PHI)$.

As explained in Section~\ref{sec:offsel}, there is a non-negligible probability that the wrong CP-state is assigned to the decay and the wrong mass hypothesis is assigned to the hadrons.
However, these mis-tagged events still contain information about the decay distribution and their contribution can be taken into account in the \pdf.
The choice of the wrong $\textrm{K}$ and $\pi$ mass hypothesis and CP-state causes some differences in the angle definition; using the Equations~\ref{eq:TLdef}, \ref{eq:TKdef}, and \ref{eq:PHIdef}, one can obtain that the correct term to use in the \pdf, as a function of the reconstructed variables, is $S^a(-\cTK,-\cTL,\PHI)$.
The efficiency function for the mis-tagged events has been computed separately: $\epsilon^{M}(\TK,\TL,\PHI)$.
Note that $\epsilon^{M}$ is defined as a function of the reconstructed variables, so there is no need to correct the signs of the angles.
The term describing the mis-tagged event contribution is multiplied by ${f^{M}}/{1-f^{M}}$ to scale it correctly with respect to the right-tagged event contribution.

As a last point, the \pdf must be able to describe the background contamination and distinguish it from the signal events.
The set of functions $B^{\TK}(\cTK) \, B^{\TL}(\cTL) \, B^{\PHI}(\PHI)$ describe the angular distribution of the background events.
However, to distinguish signal and background events the three angular variables are not useful, and a new variable is needed; the best kinematic variable for this use is the mass of the \PBz candidate.
Each of the three terms in the \pdf is then multiplied by a function describing the mass distribution: $B^m(m)$ for the background events, $S^{C}(m)$ for the right-tagged signal events, and $S^{M}(m)$ for the mis-tagged signal events.
Even if mis-tagged events are events produced by a \PBz decay, like the right-tagged events, they need a different mass-shape function because the wrong mass assignment for the hadronic tracks produce a different four-body invariant mass value.

A factor $Y_{B}$ is used to multiply the background term, while a factor $Y^{C}_{S}$ is used with the signal terms, to correctly scale the two contributions.
To give a physical meaning of number of events to these two parameters, the background term multiplying $Y_{B}$ and the right-tagged signal term multiplying $Y^{C}_{S}$ are normalised to 1 over the full phase-space.
Note that, with this definition, $Y^{C}_{S}$ stands for the number of right-tagged events, not for the total number of signal events.

\section{Parameterisation of the \pdf terms}
\label{sec:pdf-param}

%% The parameters $Y^{C}_{S}$ and $Y_{B}$ are the yields of right-tagged signal events and background events, respectively, while the parameter $f^{M}$ is the fraction of signal events that are mis-tagged.

Each of the terms $S^{C}(m)$ and $S^{M}(m)$ is composed as the sum of two Gaussian functions with different normalisation factors.
For each $q^2$ bin, all these four Gaussian functions are constrained to have the same mean value.

The determination of the mistag fraction $f^{M}$ will be presented in Section~\ref{sec:mistag}.

%% In the fit, the mean, the four Gaussian function's width parameters, and the two fractions specifying the relative contribution of the two Gaussian functions in $S^{C}(m)$ and $S^{M}(m)$ are determined from simulation.
%% The function $S^a(\TK,\TL,\PHI)$ describes the signal in the three-dimensional (3D) space of the angular variables and corresponds to Eq.~(\ref{eq:PDF}).

The construction of the three-dimensional functions $\epsilon^{C}(\TK,\TL,\PHI)$ and $\epsilon^{M}(\TK,\TL,\PHI)$ will be described in Section~\ref{sec:eff}.

The background mass shape $B^m(m)$ is parameterised by an exponential function, while the angular shapes $B^{\TK}(\cTK)$ and $B^{\TL}(\cTL)$ are polynomials functions, ranging from second to fourth degree depending on the $q^2$ bin, and $B^{\PHI}(\PHI)$ is a first-order polynomial function.
Some more details on the background description are given in Section~\ref{sec:backg}.
The factorisation assumption of the background term in Equation~(\ref{eq:angALL}) is discussed in Section~\ref{sec:fact}.

\subsection{Fraction of mis-tagged signal events}
\label{sec:mistag}

%% The signal and control channels are self-tagging decays.
%% This means that in principle one can distinguish whether the mother particle is a $B^0$ or $\overline{B}^0$ by simply measuring the charges of the daughter hadrons, but this in turn requires the capability of disentangling kaons and pions.
%% Unfortunately the CMS experiment does not possess such a capability for charged particles above $\mathcal{O}(1~\GeV)$.
%% To overcome this deficit an algorithm, based on the analysis of the invariant mass of the two hadrons has been used.
%% Both the $\pi$ and $K$ mass hypothesis is considered for each of the two hadrons of the decay: the hypothesis with an invariant mass for the two-hadrons closer to the nominal $\PKst$ one is retained.

%% As described in Section~\ref{sec:selection}, the CP-state of the candidate \PBz is affigned on the base of 
The algorithm used to tag the CP-state of the \PBz candidate, described in Section~\ref{sec:selection}, has an intrinsic percentage of failure which is referred to as mistag fraction, $f^M$, defined as the ratio of mis-tagged signal events divided by the total number of signal events.
The mistag fraction is determined from simulated events, comparing the results of the tag method to the MC truth, and by counting the number of correctly and wrongly tagged events.
The resulting mistag fractions, for each $q^2$ bin, are shown in Table~\ref{tab:mistag}.
%%%%%%%%%%%%%%%%%%%%%%%%

\begin{table}[!htb]
  \begin{center}
    %% \begin{small}
      \caption{Mistag fraction as determined from simulated MC samples, for each $q^2$ bin.
        The values in $q^2$ bins 4 and 6 are evaluated on \BtoKstJpsimumu and \BtoKstpsipmumu MC samples, respectively. For the other $q^2$ bins the values are evaluated on signal MC sample.
        \label{tab:mistag}}
      \begin{tabular}{c|l|l}
        $q^2$ bin & Mistag fraction & Statistical \\
        index     & $f^M$           & uncertainty \\
        \hline
        $0$ & $0.124$  & $0.002$  \\
        $1$ & $0.129$  & $0.001$  \\
        $2$ & $0.134$  & $0.001$  \\
        $3$ & $0.132$  & $0.001$  \\
        $4$ & $0.1373$ & $0.0005$ \\
        $5$ & $0.132$  & $0.001$  \\
        $6$ & $0.140$  & $0.002$  \\
        $7$ & $0.132$  & $0.001$  \\
        $8$ & $0.137$  & $0.001$  \\
      \end{tabular}
    %% \end{small}
  \end{center}
\end{table}

The mistag fraction parameter is fixed in the fit to the values evaluated on MC simulation.
Any differences between simulated and real events could lead to a bias in the mistag fraction values used in the \pdf, that could propagate to a bias in the analysis results.
The contribution of this effect to the systematic uncertainty is discussed in Section~\ref{sec:sys-mistag}.

\subsection{Background parameterisation}
\label{sec:backg}

Several kind of background events can contaminate the dataset used for the fit.
In this section I will present the studies performed to describe and evaluate the many sources of this contamination.

The main contribution derives from the combinatorial background, i.e. events in which the four particles of the final state do not come from the same decay vertex.
Since the four-body invariant mass distribution of these events does not show any structure, their contribution can be evaluated from the mass sidebands, and extrapolated to the full mass range.

In addition, no correlation is expected between the four-body mass distribution and the angular variable distributions.
This allows to estimate the shapes of the angular distributions on the sidebands, and assume them valid also to describe the combinatorial background contamination in the \PBz mass region.

The \pdf used to model the angular shape of this background is the product of three uncorrelated polynomial functions, $B^{\TK}(\cTK) \, B^{\TL}(\cTL) \, B^{\PHI}(\PHI)$.
The orders of the polynomial functions are chosen individually for each $q^2$ bin, in order to have them successfully describe any shape feature, while keeping the degrees of freedom as low as possible, to have a converging fit even with the low sideband statistics.
The polynomial degrees that we use are listed in the Table~\ref{tab:back-degree}.

\begin{table}[!htb]
  \begin{center}
    %% \begin{small}
    \caption{Degree of the polynomial functions used to described the angular shape of the combinatorial background distributions, for each $q^2$ bin.
      \label{tab:back-degree}}
    \begin{tabular}{c|c|c|c}
      $q^2$ bin & $B^{\TK}$ & $B^{\TL}$ & $B^{\PHI}$ \\
      index & degree & degree & degree \\
      \hline
      0 & 3 & 2 & 1 \\
      1 & 4 & 2 & 1 \\
      2 & 4 & 3 & 1 \\
      3 & 2 & 4 & 1 \\
      5 & 4 & 2 & 1 \\
      7 & 2 & 3 & 1 \\
      8 & 2 & 2 & 1 \\
    \end{tabular}
    %% \end{small}
  \end{center}
\end{table}

An example of the sideband event distributions, for $q^2$ bin~0, are plotted in Figure~\ref{fig:bin0-bkg-k}-\ref{fig:bin0-bkg-phi}, together with the projections of the combinatorial background \pdf on the angular variables, after the fit to the sideband distributions described in Section~\ref{sec:fitseq}.

\begin{figure}[!hbt]
  \centering
  \includegraphics[width=0.7\textwidth]{Figures/background/bin0-k.pdf}
  \caption{The sideband event distribution and the projection of the background \pdf as a function of $\cTK$, for $q^2$ bin~0.}
  \label{fig:bin0-bkg-k}
\end{figure}

\begin{figure}[!hbt]
  \centering
  \includegraphics[width=0.7\textwidth]{Figures/background/bin0-l.pdf}
  \caption{The sideband event distribution and the projection of the background \pdf as a function of $\cTL$, for $q^2$ bin~0.}
  \label{fig:bin0-bkg-l}
\end{figure}

\begin{figure}[!hbt]
  \centering
  \includegraphics[width=0.7\textwidth]{Figures/background/bin0-phi.pdf}
  \caption{The sideband event distribution and the projection of the background \pdf as a function of $\PHI$, for $q^2$ bin~0.}
  \label{fig:bin0-bkg-phi}
\end{figure}

%%%%%%%%%%%%%%555
Other background sources has been investigated.
None of them has been found relevant enough to be require a dedicated component in the fit \pdf.
In the following paragraphs I will present the studies performed on these possible sources of contamination and the estimates on their impact on the analysis results.

\subsubsection{Feed-through background from control channels}
\label{sec:feedThroughBkg}

The second background contamination for relevance is due to the ``feed-through'' of events from the resonant control channels, \BtoKstJpsi and \BtoKstpsip, that are not rejected by the diagonal $q-m$ cuts and populate the $q^2$ bins adjacent to the resonance regions, i.e. bin~3, 5, and 7.

The \pdf component needed to describe the distributions of these events is not included in the fit, because of its complex form and the fit general instability.
A systematic uncertainty has been set up to describe the bias introduced by this omission on the fit results.
It is described in Section~\ref{sec:feedthr}.

\subsubsection{Peaking background}
\label{sec:PeakBkg}

Using a set of simulated MC samples, possible background sources that peak in the \PBz\ mass region are investigated.

A set of inclusive MC samples of \PBz, \PBs, \PBp, and $\Lambda_{\rm b}$ hadrons decaying to $\cPJgy(\Pgmp\Pgmm)\mathrm{X}$ and $\psi'(\Pgmp\Pgmm)\mathrm{X}$, have been probed, after applying the full set of selection criteria, but the control region removal and the diagonal cuts. 
No hints for peaking structures in the region of the \PBz\ mass are found.
The mass distribution of these events is similar to the shape of the combinatorial background.

The same checks are performed with a MC sample of $\PBs \to \cPKstz({\rm K}^+ \pi^-) \Pgmp \Pgmm$ decays.
Normalising the area of the cluster near the \PBs\ mass to the correct luminosity and assuming the same branching fraction as for $\PBz \to \cPKstz({\rm K}^+ \pi^-)$ $\Pgmp \Pgmm$, about 70 such events, integrated over $q^2$, are present.
Since the branching fraction of the $\PBs \to \cPKstz \Pgmp \Pgmm$ decay has never been measure, we can assume that the same ratio of branching fractions measured for the resonant channels, $\mathcal{B}(\PBs \to \cPJgy \cPKstz) / \mathcal{B}(\BtoKstJpsi) \approx 10^{-2}$, is valid for the non-resonant channels as well.
In this case, this background can be considered negligible since we expect less than one event in the whole $q^2$ range.

In the same way, the MC samples containing $\PBp \to \PKp \Pgmp \Pgmm$ and $\Lambda_b \to \mathrm{p} \mathrm{K} \Pgmp \Pgmm$ events are tested.
In this case the mass values assigned to the hadrons in the final state are changed with respect to the original ones, to one kaon mass and one pion mass, assigned according to the tagging criterion described in Section~\ref{sec:offsel}.
Both these potential sources of background are found to be negligible.

\subsubsection{Background from muon misidentification}
\label{sec:muMisidBkg}

A possible background contamination can come from events with hadrons misidentified as muons, or vice-versa.
To peak under in the signal mass region, these events can be either a four-hadron final states from \PB meson decay, like the \PD meson mediated decays $\PBz \to \PD {\rm X}$, with a pair of opposite-sign hadrons misidentified as muons, or a control-channel decay \BtoKstJpsidecay in which both one of the two muons has been misidentified as hadron and one of the two hadrons has been misidentified as muon.
These contributions are calculated to be negligible because of the good muon identification capabilities of the CMS detector~\cite{Chatrchyan:2012xi}.

\subsubsection{Test of factorisable background hypothesis}
\label{sec:fact}

The result of a test on the correlation of the variable distributions for the combinatorial background events is shown in this section.

For each angular variable, the mass sideband sample has been divided in two sub-samples, cutting in the middle of the variable range.
Then, the two sub-sample distributions as functions of the other variables are compared.
Furthermore, the angular variable distributions of the lower and higher sidebands are compared.

These comparisons are performed for each signal bin, for each control sample, and for two ``special bins'' that merge events in bin ranges [0-3] and [8-9], respectively.
As example, the distributions for the special $q^2$ bin [0-3] are showed in Figure~\ref{fig:side9}, where four plots are shown, one for each variable, and in each plot six distributions are compared, corresponding to the three pair of sub-samples obtained cutting on the not-plotted variables.
%% The colour code identifies the sub-sample:
%% \begin{center}
%% \begin{tabular}{c|c}
%% dim green & $\cos\theta_K$ lower half\\
%% grey & $\cos\theta_K$ higher half\\
%% black & $\cos\theta_L$ lower half\\
%% red & $\cos\theta_L$ higher half\\
%% bright green & $\phi$ lower half\\
%% blue & $\phi$ higher half\\
%% magenta & low mass sideband\\
%% light blue & high mass sideband\\
%% \end{tabular}
%% \end{center}

For some bins the low statistics don't allow to compare the distributions, but in the other bins and in the merged ones the good compatibility is probed.

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands0.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 0. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side0}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands1.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 1. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side1}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands2.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 2. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side2}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands3.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 3. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side3}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands4.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $J/\psi$ control region. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side4}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands5.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 5. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side5}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands6.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $\psi(2S)$ control region. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side6}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands7.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 7. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side7}
%% \end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands8.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin 8. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side8}
%% \end{figure}

\begin{figure}[!hbt]
  \centering
  \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands9.pdf}
  \caption{Distributions of the sideband events as a function of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right), in the $q^2$ bin range [0,3]. As described in Section~\ref{sec:fact}, each distribution corresponds to a different sub-sample of the sideband events: $\cos\theta_K$ lower half (dim green) and upper half (grey), $\cos\theta_L$ lower half (black) and upper half (red), $\phi$ lower half (bright green) and upper half (blue), and low and high mass sidebands (magenta and light blue, respectively).}
  \label{fig:side9}
\end{figure}

%% \begin{figure}[!hbt]
%%   \centering
%%   \includegraphics[width=0.85\textwidth]{Figures/bkg_fact/sidebands10.pdf}
%%   \caption{Distributions of $\cos\theta_K$ (top left), $\cos\theta_L$ (top right), $\phi$ (bottom left), $m_{K\pi\mu\mu}$ (bottom right) for subsamples of the data sideband events, in the $q^2$ bin range [7,8]. The procedure to obtained these subsamples is described in App.~\ref{sec:app-bkg.fact}. }
%%   \label{fig:side10}
%% \end{figure}

\section{The fitting sequence, components and strategy}
\label{sec:fitseq}

Before applying the fit procedure on data, some parameters of the \pdf in Equation~\ref{eq:angALL} are estimated, for each $q^2$ bin, on the simulated signal MC sample and kept fixed for the full fitting process.
These parameters are the mistag fraction $f^{M}$, as described in Section~\ref{sec:mistag}, and the seven parameters of the signal mass component of the \pdf: the two widths and the relative abundance for the double Gaussian describing the right-tagged events, the same for the double Gaussian describing the mis-tagged events, and the common mean.
To take into account the effect of any difference between simulated and real events, a specific systematic uncertainty have been computed and will be described in Section~\ref{sec:syst}.
%% The PDF components whose parameters are determined with a MC simulaion are: $f^{M}$, $S^{C}(m)$, $S^{M}(m)$, $\epsilon^{C}(\TK,\theta_l,\phi)$ and $\epsilon^{M}(\TK,\theta_l,\phi)$, while all the remaining parameters are determined on data.

The angular component of the signal \pdf, as described by Equation~(\ref{eq:PDF-f2}), depends on six  parameters, $F_\mathrm{L}$, $F_\mathrm{S}$, $A_\mathrm{S}$, $P_1$, $P_5'$, and $A^5_\mathrm{S}$.
In order to facilitate the convergence of the fit process, and avoid problems related to the limited number of events and the presence of the physical boundary in the parameter phase space, the angular parameters that have already been measured by the previous CMS analysis on the same dataset, $F_\mathrm{L}$, $F_\mathrm{S}$, and $A_\mathrm{S}$, have been fixed to the results of that measurement.
To take into account the effect of fixing these parameters, a systematic uncertainty has been computed and will be described in Section~\ref{sec:syst}.

%% In order to avoid fit convergence problems due to the limited number of signal candidate events the angular parameters $F_\mathrm{L}$, $F_\mathrm{S}$, and $A_\mathrm{S}$ are fixed to previous CMS measurements performed on the same dataset with the same event selection criteria~\cite{CMS:2012}.
%% For each $q^2$ bin, the observables of interest are extracted from an unbinned extended maximum-likelihood fit to four variables: the $\PKp\Pgpm\Pgmp\Pgmm$ invariant mass $m$ and the three angular variables ${\TK}$, ${\theta_l}$, and $\phi$.

%%%%%%%%%%%%%%%%%%%%%%%55555

The fit is performed in two steps.
In the first one, the sidebands events are fitted, using only the background component of the \pdf, to obtain the parameters of the $B^m(m)$, $B^{\TK}(\TK)$, $B^{\theta_l}(\theta_l)$, and $B^{\phi}(\phi)$ distributions.
These parameters are then kept fixed in the second step of the fit.
To correctly propagate the uncertainties on the background parameters to the analysis results, a specific systematic uncertainty has been computed and will be described in Section~\ref{sec:syst}.

%% The sideband regions are $3\sigma_m < \abs{m-m_{\PBz}} < 5.5\sigma_m$, where $\sigma_m$ is the average mass resolution ($\approx$45\MeV), obtained from fitting the MC simulation signal to a sum of two Gaussians with a common mean.
In the second step, the full set of events is fitted using the whole \pdf.
The free parameters in this fit are the angular parameters $P_1$, $P_5'$, and $A^5_\mathrm{S}$, and the yields $Y^{C}_{S}$ and $Y_{B}$.

The separation of the fit in these two steps is needed to allow a stable fit to the signal region.
As described in Section~\ref{sec:backg} the angular shape of the background events contains a high number of parameters and evaluating them together with the signal components would lead to a very unstable fit.
Furthermore, using this two-step fit allows to keep the background parameters fixed for any fit procedure applied on data; this has the benefit of saving a huge amount of computing time, especially when large series of fits are run for systematic uncertainty estimations or for finding the best-fit values of the parameters, as described in the following paragraph.

%% The expression describing the angular distribution of $\mathrm{B}^0\to{\mathrm{K}^*\mu\mu}$, Eq.~(\ref{eq:PDF-f2}) and also its more general form in Ref.~\cite{Descotes-Genon:2013vna}, can become negative for certain values of the angular parameters.
%% In particular the PDF in Eq.~(\ref{eq:PDF}) is only guaranteed to be non-negative for a particular subset of the parameter space $P_1$, $P_5'$, and $A^5_\mathrm{S}$, whose mathematical expression is non trivial.
The second step of the fit cannot be run at once, since the presence of a physical boundary for the validity of the fitted parameters complicates the process of numerical maximisation of the likelihood performed by \textsc{minuit}~\cite{Minuit}.
Especially in the $q^2$ bins in which the likelihood maximum is close to this boundary, the maximisation results tend to be unstable and strongly dependent on the values of the parameters at the begin of the fit.
A strategy was then developed to avoid the effect of the physical boundary: the bi-dimensional space $P_1$ -- $P_5'$ is discretised by building a $90\times90$ rectangular grid, and for each of its points the values of $P_1$, $P_5'$ are fixed in the fit, and the likelihood is maximised as a function of the nuisance parameters $Y^{C}_{S}$, $Y_{B}$, and $A^5_\mathrm{S}$.
Once the likelihood has been minimised for each point of the grid, it is fit with a bi-variate Normal distribution.
The position of the maximum of this function, limited to the physical region, corresponds to the best estimate of the angular parameters $P_1$, $P_5'$.
To avoid that any eventual non-Gaussian behaviour of the likelihood distribution in regions far from the maximum could introduce a bias in the results, the fit with the bi-variate Normal distribution is limited to the grid points ($P_1^i$, $P_5'^i$) for which is valid the following request: $$\log\mathcal{L}(P_1^i,P_5'^i) > \log\mathcal{L}(P_1^{\mathrm{max}},P_5'^{\mathrm{max}}) - 0.5$$ where ($P_1^{\mathrm{max}}$, $P_5'^{\mathrm{max}}$) is the grid point for which the likelihood is maximum.
In this way the grid points fitted are limited to a region around the maximum position.
The dependence of the fit result as a function of the region width, has been tested and found to be negligible, as will be discussed in Section~\ref{sec:bestFit}.

%% The presence of such a physical region greatly complicates the numerical maximisation process of the likelihood by \textsc{minuit}~\cite{Minuit} and especially the error determination by \textsc{minos}~\cite{Minuit}, in particular next to the boundary between physical and unphysical regions.
%% Therefore the second fit step is performed by discretizing the bidimensional space $P_1$ -- $P_5'$, and by maximising the likelihood as a function of the nuisance parameters $Y^{C}_{S}$, $Y_{B}$, and $A^5_\mathrm{S}$ at fixed values of $P_1$, $P_5'$.
%% Finally the distribution of the likelihood values is fit with a bivariate Normal distribution whose position of the maximum inside the physical region corresponds to the best estimate of the angular parameters $P_1$, $P_5'$.

%% When we perform the final fit we need to make sure that we are discretizing the subset of the physical region $P_1$ -- $P_5'$ containing the absolute maximum of the likelihood.
%% To this extent we fit the data 200 times, each time with starting values of the parameters $P_1$ and $P_5'$ chosen randomly according to a uniform distribution defined over their physical region.

%%%%%%%%%%%%%%%%%%%%%%%55555


%% In this note we require that all the fitts have the status ``GOOD'', with which are labelled the plots.
%% The ``GOOD'' label depends upon two conditions: the convergence is verified, and the positive definiteness of the covariance matrix is confirmed.

%% The interference terms $A_\mathrm{S}$ and $A^5_\mathrm{S}$ must vanish if either of the two interfering components vanish.
%% From Ref.~\cite{Descotes-Genon:2013vna}, these constraints are implemented as $\abs{A_\mathrm{S}} < \sqrt{12 F_\mathrm{S}(1-F_\mathrm{S})F_\mathrm{L}}R$ and as $\abs{A^5_\mathrm{S}} < \sqrt{3 F_\mathrm{S} (1-F_\mathrm{S}) (1-F_\mathrm{L}) (1+P_1)}R$, where $R$ is a ratio related to the S-wave and P-wave line shapes, estimated to be 0.89 near the $\cPKstz$ mass.
%% The constraint on $A_\mathrm{S}$ is naturally satisfied since the measurement of the parameters $F_\mathrm{S}$, $F_\mathrm{L}$, and $A_\mathrm{S}$ are inherited from the previous CMS analysis~\cite{CMS:2012}.

%% To ensure correct coverage for the uncertainties of the angular parameters, the Feldman-Cousins method~\cite{FC} is used with nuisance parameters.
%% Two main sets of pseudo-experimental samples are generated to compute the coverage for the two angular observables $P_1$ and $P_5'$, respectively.
%% The first (second) set, used to compute the coverage for $P_1$ ($P_5'$), is generated by assigning values to the other parameters as obtained by profiling the likelihood on data at fixed $P_1$ ($P_5'$) values.
%% When fitting the pseudo-experimental samples the same fit procedure as in data is applied (more details can be found in Sec.~\ref{sec:statUncert}).

%% The fit formalism and results are validated through fits to pseudo-experimental samples, MC simulation samples, and control channels.
